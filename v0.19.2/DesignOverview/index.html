<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>PALEOboxes coupler design · PALEOboxes Documentation</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.044/juliamono.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">PALEOboxes Documentation</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><span class="tocitem">Design</span><ul><li class="is-active"><a class="tocitem" href>PALEOboxes coupler design</a><ul class="internal"><li><a class="tocitem" href="#Composing-Reactions-and-Variables-within-a-[Domain](@ref)"><span>Composing Reactions and Variables within a <code>Domain</code></span></a></li><li><a class="tocitem" href="#Coupling-Spatial-Domains"><span>Coupling Spatial Domains</span></a></li><li><a class="tocitem" href="#Separating-time-integration,-reaction,-and-transport"><span>Separating time integration, reaction, and transport</span></a></li></ul></li><li><a class="tocitem" href="../CreateInitializeLoop/">Control flow</a></li></ul></li><li><span class="tocitem">Reference</span><ul><li><a class="tocitem" href="../DomainsVariablesFields/">Domains, Variables, Fields, and Data arrays.</a></li><li><a class="tocitem" href="../Solver API/">Solver API</a></li><li><a class="tocitem" href="../Reaction API/">Reaction API</a></li><li><a class="tocitem" href="../ReactionCatalog/">Generic Reaction catalog</a></li></ul></li><li><a class="tocitem" href="../References/">References</a></li><li><a class="tocitem" href="../indexpage/">Index</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Design</a></li><li class="is-active"><a href>PALEOboxes coupler design</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>PALEOboxes coupler design</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/PALEOtoolkit/PALEOboxes.jl/blob/main/docs/src/DesignOverview.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="PALEOboxes-coupler-design"><a class="docs-heading-anchor" href="#PALEOboxes-coupler-design">PALEOboxes coupler design</a><a id="PALEOboxes-coupler-design-1"></a><a class="docs-heading-anchor-permalink" href="#PALEOboxes-coupler-design" title="Permalink"></a></h1><p>A PALEO <a href="../DomainsVariablesFields/#PALEOboxes.Model"><code>Model</code></a> contains <a href="../DomainsVariablesFields/#PALEOboxes.Domain"><code>Domain</code></a>s, each of which contain Variables defining <a href="../DomainsVariablesFields/#PALEOboxes.Field"><code>Field</code></a>s containing <code>Data</code> arrays, and Reactions with <a href="../Reaction API/#PALEOboxes.ReactionMethod"><code>ReactionMethod</code></a>s that operate on the Variables to calculate model time evolution.</p><p>The PALEOboxes Julia package (abbreviated to <code>PB</code> in the PALEO code) implements a coupler that provides a unified mechanism for</p><ol><li>‘low-level’ coupling (e.g. linking individual redox Reactions within a <a href="../DomainsVariablesFields/#PALEOboxes.Domain"><code>Domain</code></a>), on which is built</li><li>‘module-level’ coupling (linking e.g. atmosphere and ocean components) based on standardising names for communicating fluxes, and which enables</li><li>separation of biogeochemical reaction and transport. </li></ol><p>A <a href="https://en.wikipedia.org/wiki/YAML">YAML</a> format configuration file then defines both the model structure (spatial domains containing biogeochemical variables and reactions that operate on them) and model parameter values.</p><h2 id="Composing-Reactions-and-Variables-within-a-[Domain](@ref)"><a class="docs-heading-anchor" href="#Composing-Reactions-and-Variables-within-a-[Domain](@ref)">Composing Reactions and Variables within a <a href="../DomainsVariablesFields/#PALEOboxes.Domain"><code>Domain</code></a></a><a id="Composing-Reactions-and-Variables-within-a-[Domain](@ref)-1"></a><a class="docs-heading-anchor-permalink" href="#Composing-Reactions-and-Variables-within-a-[Domain](@ref)" title="Permalink"></a></h2><h6 id="Figure-1"><a class="docs-heading-anchor" href="#Figure-1">Figure 1</a><a id="Figure-1-1"></a><a class="docs-heading-anchor-permalink" href="#Figure-1" title="Permalink"></a></h6><p><img src="../images/ocean_domain.png" alt/></p><p><em>The PALEOboxes object model illustrated by a fragment of a marine biogeochemical model representing two phytoplankton populations competing for the same nutrient. The Ocean Domain contains two Reactions phytA and phytB, and three state Variables P, phytA and phytB with paired time derivatives P_sms, phytA_sms and phytB_sms. The Reactions are both instances of the same class PaleoReactionSimplePhyt, with a Parameter k_P, and a single method. The ReactionMethod defines interactions with a nutrient P via a Variable Dependency P and a Variable Contributor P_sms, and a population represented by Variable Dependency phyt and Contributor phyt_sms. P and P_sms from each PaleoReactionSimplePhyt instance are linked at run time to the same Domain Variables P and P_sms, using the default names from the PaleoReactionSimplePhyt code.  phyt and phyt_sms are renamed in the configuration file to two different pairs of Domain Variables phytA, phytA_sms and phytB, phytB_sms, hence representing two distinct phytoplankton populations.</em></p><h3 id="Reactions-and-ReactionMethods"><a class="docs-heading-anchor" href="#Reactions-and-ReactionMethods">Reactions and ReactionMethods</a><a id="Reactions-and-ReactionMethods-1"></a><a class="docs-heading-anchor-permalink" href="#Reactions-and-ReactionMethods" title="Permalink"></a></h3><p>Reactions contain <a href="../Reaction API/#PALEOboxes.Parameter"><code>Parameter</code></a>s and are implemented as subtypes of <a href="../Reaction API/#PALEOboxes.AbstractReaction"><code>AbstractReaction</code></a> along with associated methods. <a href="../Reaction API/#PALEOboxes.ReactionMethod"><code>ReactionMethod</code></a>s and <a href="../DomainsVariablesFields/#PALEOboxes.VariableReaction"><code>VariableReaction</code></a>s are created by Reactions during model initialization. All PALEO model time evolution (including external prescribed forcing, biogeochemistry, transport within eg an ocean Domain) is then implemented by the <a href="../Reaction API/#PALEOboxes.ReactionMethod"><code>ReactionMethod</code></a>s as they are called during the model main loop.</p><h3 id="Biogeochemical-Variables"><a class="docs-heading-anchor" href="#Biogeochemical-Variables">Biogeochemical Variables</a><a id="Biogeochemical-Variables-1"></a><a class="docs-heading-anchor-permalink" href="#Biogeochemical-Variables" title="Permalink"></a></h3><p>Variables defined as <a href="../DomainsVariablesFields/#PALEOboxes.VariableReaction"><code>VariableReaction</code></a>s are then linked within (or across) Domains, creating corresponding <a href="../DomainsVariablesFields/#PALEOboxes.VariableDomain"><code>VariableDomain</code></a>s.  Linking of Variables is based on names (as text strings).  Default names are encoded in the Reaction implementations (with standard names for e.g. chemical species such as O2, DIC marine tracers), and can be overridden in the configuration file.  This is analogous to the use of ‘dummy variables’ in a Fortran or Python function  call, and allows (i) a combination of default names for commonly-used biogeochemical variables (‘P’, ‘SO4’ etc), with (ii) renamed variables to allow multiple Reaction instances (e.g. two phytoplankton populations with state variable names and parameter choices for the same Reaction implementation),  or (iii) enable rerouting of fluxes and dependencies that are specific to the model configuration, or (iv) sort out name conflicts where no default names have been established.</p><p>Variables are classified into two pairings: Properties with Dependencies (shown shaded green in <a href="#Figure-1">Figure 1</a>, linked at run time to <a href="../DomainsVariablesFields/#PALEOboxes.Domain"><code>Domain</code></a> <a href="../DomainsVariablesFields/#PALEOboxes.VariableDomPropDep"><code>VariableDomPropDep</code></a>s),  or flux Targets and Contributors (shaded pink in <a href="#Figure-1">Figure 1</a>, linked at run-time to <a href="../DomainsVariablesFields/#PALEOboxes.Domain"><code>Domain</code></a> <a href="../DomainsVariablesFields/#PALEOboxes.VariableDomContribTarget"><code>VariableDomContribTarget</code></a>s). This classification retains flexibility while providing sufficient information to allow automatic detection of errors in model specification (for example, a Dependency with no Property, or a flux Contributor with no Target), and automatic scheduling of Reactions within the model main loop (as a Reaction that defines a Property must be executed before a Reaction that Depends on this property).</p><p>Variables can specify metadata as an extensible list of attributes which can then be queried (using <a href="../DomainsVariablesFields/#PALEOboxes.get_attribute"><code>get_attribute</code></a>) and filtered on (using <a href="../Solver API/#PALEOboxes.get_variables"><code>get_variables</code></a>) during model configuration and initialisation. This enables the labelling of groups of variables (e.g. the <code>:advect</code> and <code>:vertical_motion</code> attributes are used by a Reaction implementing ocean transport to identify those state variables representing solutes that should be transported; the <code>:vfunction</code> attribute is used by numerical solvers to identify state variables and their time derivatives).</p><h3 id="Spatially-resolved-Domains-and-Grids"><a class="docs-heading-anchor" href="#Spatially-resolved-Domains-and-Grids">Spatially-resolved Domains and Grids</a><a id="Spatially-resolved-Domains-and-Grids-1"></a><a class="docs-heading-anchor-permalink" href="#Spatially-resolved-Domains-and-Grids" title="Permalink"></a></h3><p>Domains may contain a Grid (a subtype of <a href="../DomainsVariablesFields/#PALEOboxes.AbstractMesh"><code>AbstractMesh</code></a>) to define a spatially-resolved Domain containing multiple cells.</p><p>Three-dimensional <a href="../DomainsVariablesFields/#PALEOboxes.Domain"><code>Domain</code></a>s (eg ocean) are associated with two-dimensional boundary <a href="../DomainsVariablesFields/#PALEOboxes.Domain"><code>Domain</code></a>s (eg oceansurface, oceanfloor), and also provide <a href="../DomainsVariablesFields/#Subdomains">Subdomains</a> (subtypes of <a href="../DomainsVariablesFields/#PALEOboxes.AbstractSubdomain"><code>AbstractSubdomain</code></a>, eg ocean.oceansurface, ocean.oceanfloor) that specify the subset of 3D ocean cells adjacent to the 2D boundaries.</p><h3 id="Fields-and-Data"><a class="docs-heading-anchor" href="#Fields-and-Data">Fields and Data</a><a id="Fields-and-Data-1"></a><a class="docs-heading-anchor-permalink" href="#Fields-and-Data" title="Permalink"></a></h3><p>Variables contain <a href="../DomainsVariablesFields/#PALEOboxes.Field"><code>Field</code></a>s which represent data (a subtype of <a href="../DomainsVariablesFields/#PALEOboxes.AbstractData"><code>AbstractData</code></a> defined by the <code>:field_data</code> ttribute) in a function space (a subtype of <a href="../DomainsVariablesFields/#PALEOboxes.AbstractSpace"><code>AbstractSpace</code></a> defined by the <code>:space</code> attribute).</p><p>The <a href="../DomainsVariablesFields/#PALEOboxes.AbstractSpace"><code>AbstractSpace</code></a> subtype (see <a href="../DomainsVariablesFields/#Spaces">Spaces</a>) can define a per-Domain (<a href="../DomainsVariablesFields/#PALEOboxes.ScalarSpace"><code>ScalarSpace</code></a>) or per-cell (<a href="../DomainsVariablesFields/#PALEOboxes.CellSpace"><code>CellSpace</code></a>) quantity, where the number of cells is defined by the Domain grid.</p><p>The <a href="../DomainsVariablesFields/#PALEOboxes.AbstractData"><code>AbstractData</code></a> subtype (see <a href="../DomainsVariablesFields/#Data-types">Data types</a>) defines the information that is stored per Domain or per grid cell. <a href="../DomainsVariablesFields/#PALEOboxes.ScalarData"><code>ScalarData</code></a> defines one value, <a href="../DomainsVariablesFields/#PALEOboxes.ArrayScalarData"><code>ArrayScalarData</code></a> an array of scalar values eg for intensity on a wavelength grid, and <a href="../DomainsVariablesFields/#PALEOboxes.AbstractIsotopeScalar"><code>AbstractIsotopeScalar</code></a> a multiple-component isotope system (see <a href="../DomainsVariablesFields/#Isotopes">Isotopes</a>).</p><h2 id="Coupling-Spatial-Domains"><a class="docs-heading-anchor" href="#Coupling-Spatial-Domains">Coupling Spatial Domains</a><a id="Coupling-Spatial-Domains-1"></a><a class="docs-heading-anchor-permalink" href="#Coupling-Spatial-Domains" title="Permalink"></a></h2><h6 id="Figure-2"><a class="docs-heading-anchor" href="#Figure-2">Figure 2</a><a id="Figure-2-1"></a><a class="docs-heading-anchor-permalink" href="#Figure-2" title="Permalink"></a></h6><p><img src="../images/multiple_domains.png" alt/></p><p><em>Defining and coupling spatial Domains.  The four Domains atm, oceansurface, ocean and fluxAtmOceansurface are defined in the model configuration file. The first three of these contain arbitrary biogeochemical Reactions and Variables. Domain fluxAtmOceansurface contains only a FluxTarget Reaction and a set of Target Variables flux<em>O2. Exchange fluxes are accumulated into these flux</em> Variables (in this case, produced by air-sea exchange reactions in the oceansurface Domain), and then redistributed to atm and ocean by the FluxTransfer Reactions taking account of mapping between Domain dimensions.</em></p><p>Coupling between Earth system components is provided by <a href="../ReactionCatalog/#Fluxes">Fluxes</a>, implemented by <a href="../ReactionCatalog/#PALEOboxes.Fluxes.ReactionFluxTarget"><code>Fluxes.ReactionFluxTarget</code></a>s (<a href="#Figure-2">Figure 2</a>) that provide a set of flux Target Variables in nominated flux coupler <a href="../DomainsVariablesFields/#PALEOboxes.Domain"><code>Domain</code></a>s, and <a href="../ReactionCatalog/#PALEOboxes.Fluxes.ReactionFluxTransfer"><code>Fluxes.ReactionFluxTransfer</code></a> that then transfer fluxes (with appropriate mapping) to a different <a href="../DomainsVariablesFields/#PALEOboxes.Domain"><code>Domain</code></a>.</p><p>Variable text names may be referred to from other <a href="../DomainsVariablesFields/#PALEOboxes.Domain"><code>Domain</code></a>s by prefixing with Domain and Subdomain names (eg ocean.P_conc links to the 3D ocean interior Variable P_conc, ocean.oceansurface.O2_conc links to the ocean oxygen concentration for the 2D subset of ocean cells adjacent to the oceansurface boundary).</p><h2 id="Separating-time-integration,-reaction,-and-transport"><a class="docs-heading-anchor" href="#Separating-time-integration,-reaction,-and-transport">Separating time integration, reaction, and transport</a><a id="Separating-time-integration,-reaction,-and-transport-1"></a><a class="docs-heading-anchor-permalink" href="#Separating-time-integration,-reaction,-and-transport" title="Permalink"></a></h2><h6 id="Figure-3"><a class="docs-heading-anchor" href="#Figure-3">Figure 3</a><a id="Figure-3-1"></a><a class="docs-heading-anchor-permalink" href="#Figure-3" title="Permalink"></a></h6><p><img src="../images/solver_domains.png" alt/> <em>Examples of model configurations with different reaction/transport partitioning: a) a configuration with offline transport and forcing provided by Reactions within the PALEO framework. The only external dependencies are state variables and derivatives, with time integration provided by a standard ODE solver such as CVODE and the overall model workflow (initialisation, solution, output) managed by the PALEOmodel package. b) an ocean-only model embedded in a GCM host which provides transport and physical properties such as temperature and sequences the model workflow.</em></p><p>The <code>:vfunction</code> Variable attribute is used to identify pairs of state variables (labelled with <code>:vfunction = VF_StateExplicit</code>) and their corresponding time derivatives (labelled with <code>:vfunction = VF_Deriv</code>). Algebraic constraints are defined by Variables labelled with <code>:vfunction = VF_Constraint</code>, with a corresponding number of state variables labelled with <code>:vfunction = VF_State</code>. Implicit variables are defined by pairs of variables and time derivatives labelled with <code>:vfunction = VF_Total</code> and  <code>:vfunction = VF_Deriv</code>, with a corresponding number of state variables labelled with <code>:vfunction = VF_State</code>. </p><p>To access variables, a numerical ODE or DAE solver can use <a href="../Solver API/#PALEOboxes.VariableAggregator"><code>VariableAggregator</code></a> to implement a high-level interface to aggregated lists. A host dynamical model can alternatively use <a href="../Solver API/#PALEOboxes.get_variables"><code>get_variables</code></a> during model configuration and initialisation to link to individual host data arrays.  </p><p>The abstractions described above enable a natural separation of biogeochemical reaction and transport, which can then either be provided by a host dynamical model e.g. implemented in C or Fortran, or as offline transport implemented by PALEO “reactions” within the framework (<a href="#Figure-3">Figure 3</a>). This enables both rapid, interactive development and experimentation in a PC/workstation environment using offline transport, and deployment of the same model code as a component embedded in a larger GCM model.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../">« Home</a><a class="docs-footer-nextpage" href="../CreateInitializeLoop/">Control flow »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.19 on <span class="colophon-date" title="Sunday 26 June 2022 19:19">Sunday 26 June 2022</span>. Using Julia version 1.6.6.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
