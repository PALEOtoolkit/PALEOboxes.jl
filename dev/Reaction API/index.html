<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Reaction API · PALEOboxes Documentation</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">PALEOboxes Documentation</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><span class="tocitem">Design</span><ul><li><a class="tocitem" href="../DesignOverview/">PALEOboxes coupler design</a></li><li><a class="tocitem" href="../CreateInitializeLoop/">Control flow</a></li></ul></li><li><span class="tocitem">Reference</span><ul><li><a class="tocitem" href="../DomainsVariablesFields/">Domains, Variables, Fields, and Data arrays.</a></li><li><a class="tocitem" href="../Solver API/">Solver API</a></li><li class="is-active"><a class="tocitem" href>Reaction API</a><ul class="internal"><li><a class="tocitem" href="#Reaction-struct"><span>Reaction struct</span></a></li><li><a class="tocitem" href="#Parameters"><span>Parameters</span></a></li><li><a class="tocitem" href="#Registering-Reactions-with-the-PALEOboxes-framework"><span>Registering Reactions with the PALEOboxes framework</span></a></li><li><a class="tocitem" href="#Defining-Domain-Grids-and-array-sizes"><span>Defining Domain Grids and array sizes</span></a></li><li><a class="tocitem" href="#Creating-and-registering-Reaction-methods"><span>Creating and registering Reaction methods</span></a></li><li><a class="tocitem" href="#Predefined-ReactionMethods"><span>Predefined ReactionMethods</span></a></li><li><a class="tocitem" href="#Internal-details-of-Variable-arrays-accessor-generation"><span>Internal details of Variable arrays accessor generation</span></a></li></ul></li><li><a class="tocitem" href="../ReactionCatalog/">Generic Reaction catalog</a></li></ul></li><li><a class="tocitem" href="../References/">References</a></li><li><a class="tocitem" href="../indexpage/">Index</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Reference</a></li><li class="is-active"><a href>Reaction API</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Reaction API</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/PALEOtoolkit/PALEOboxes.jl/blob/main/docs/src/Reaction API.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Reaction-API"><a class="docs-heading-anchor" href="#Reaction-API">Reaction API</a><a id="Reaction-API-1"></a><a class="docs-heading-anchor-permalink" href="#Reaction-API" title="Permalink"></a></h1><p>API calls used by <a href="#PALEOboxes.AbstractReaction"><code>AbstractReaction</code></a> implementations.</p><p>Implementations should create a subclass of <a href="#PALEOboxes.AbstractReaction"><code>AbstractReaction</code></a> containing a <a href="#PALEOboxes.ReactionBase"><code>ReactionBase</code></a> and <a href="#PALEOboxes.Parameter"><code>Parameter</code></a>s, optionally provide a <a href="#PALEOboxes.create_reaction-Tuple{Type{var&quot;#s6&quot;} where var&quot;#s6&quot;&lt;:PALEOboxes.AbstractReaction, PALEOboxes.ReactionBase}"><code>create_reaction</code></a>, and implement callbacks to define <a href="#PALEOboxes.VariableReaction"><code>VariableReaction</code></a>s and register <a href="#PALEOboxes.ReactionMethod"><code>ReactionMethod</code></a>s.</p><h2 id="Reaction-struct"><a class="docs-heading-anchor" href="#Reaction-struct">Reaction struct</a><a id="Reaction-struct-1"></a><a class="docs-heading-anchor-permalink" href="#Reaction-struct" title="Permalink"></a></h2><article class="docstring"><header><a class="docstring-binding" id="PALEOboxes.AbstractReaction" href="#PALEOboxes.AbstractReaction"><code>PALEOboxes.AbstractReaction</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">AbstractReaction</code></pre><p>Abstract base Type for Reactions.</p><p><strong>Implementation</strong></p><p>Derived types should include a field <code>base::</code><a href="#PALEOboxes.ReactionBase"><code>ReactionBase</code></a>, and usually a <a href="#PALEOboxes.ParametersTuple"><code>ParametersTuple</code></a>, eg</p><pre><code class="nohighlight hljs">Base.@kwdef mutable struct ReactionHello{P} &lt;: PB.AbstractReaction
    base::PB.ReactionBase

    pars::P = PB.ParametersTuple(
        PB.ParDouble(&quot;my_par&quot;, 42.0, units=&quot;yr&quot;, 
            description=&quot;an example of a Float64-valued scalar parameter called &#39;my_par&#39;&quot;),
    )

    some_additional_field::Float64   # additional fields to eg cache data read from disk etc
end</code></pre><p>Derived types should implement <a href="#PALEOboxes.register_methods!"><code>register_methods!</code></a>, and may optionally implement <a href="#PALEOboxes.create_reaction-Tuple{Type{var&quot;#s6&quot;} where var&quot;#s6&quot;&lt;:PALEOboxes.AbstractReaction, PALEOboxes.ReactionBase}"><code>create_reaction</code></a>,  <a href="#PALEOboxes.set_model_geometry"><code>set_model_geometry</code></a>, <a href="../Solver API/#PALEOboxes.check_configuration-Tuple{PALEOboxes.Model}"><code>check_configuration</code></a>, <a href="#PALEOboxes.register_dynamic_methods!"><code>register_dynamic_methods!</code></a>.</p><p>Methods should be registered using <a href="#PALEOboxes.add_method_setup!"><code>add_method_setup!</code></a>, <a href="#PALEOboxes.add_method_initialize!"><code>add_method_initialize!</code></a>, <a href="#PALEOboxes.add_method_do!"><code>add_method_do!</code></a>.</p><p>Any parameters not included in <code>pars</code> should be added explicitly with <a href="#PALEOboxes.add_par"><code>add_par</code></a> (this is rarely needed).</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/PALEOtoolkit/PALEOboxes.jl/blob/3a6af11e6f23cc9c2cd1953fc504a48747749f98/src/Reaction.jl#L2-L27">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="PALEOboxes.ReactionBase" href="#PALEOboxes.ReactionBase"><code>PALEOboxes.ReactionBase</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">ReactionBase</code></pre><p>Base Type for a biogeochemical Reaction.</p><p><strong>Implementation</strong></p><p>Include as field <code>base</code> in types derived from <a href="#PALEOboxes.AbstractReaction"><code>AbstractReaction</code></a></p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/PALEOtoolkit/PALEOboxes.jl/blob/3a6af11e6f23cc9c2cd1953fc504a48747749f98/src/Reaction.jl#L30-L37">source</a></section></article><h2 id="Parameters"><a class="docs-heading-anchor" href="#Parameters">Parameters</a><a id="Parameters-1"></a><a class="docs-heading-anchor-permalink" href="#Parameters" title="Permalink"></a></h2><article class="docstring"><header><a class="docstring-binding" id="PALEOboxes.AbstractParameter" href="#PALEOboxes.AbstractParameter"><code>PALEOboxes.AbstractParameter</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">AbstractParameter</code></pre><p>Base Type for Parameters</p><p>See also: <a href="#PALEOboxes.Parameter"><code>Parameter</code></a>, <a href="#PALEOboxes.VecParameter"><code>VecParameter</code></a>, <a href="#PALEOboxes.VecVecParameter"><code>VecVecParameter</code></a></p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/PALEOtoolkit/PALEOboxes.jl/blob/3a6af11e6f23cc9c2cd1953fc504a48747749f98/src/Parameter.jl#L4-L10">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="PALEOboxes.Parameter" href="#PALEOboxes.Parameter"><code>PALEOboxes.Parameter</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">Parameter{T, ParseFromString}</code></pre><p>A reaction parameter of type <code>T</code>.</p><p>Create using short names <code>ParDouble</code>, <code>ParInt</code>, <code>ParBool</code>, <code>ParString</code>.</p><p>Read value as <code>&lt;par&gt;[]</code>, set with <a href="#PALEOboxes.setvalue!"><code>setvalue!</code></a>.</p><p>Parameters with <code>external=true</code> may be set from the Model-level Parameters list, if <code>name</code> is present in that list.</p><p><code>ParseFromString</code> should usually be <code>Nothing</code>: a value of <code>Type T</code> is then required when calling <a href="#PALEOboxes.setvalue!"><code>setvalue!</code></a>. If <code>ParseFromString</code> is not <code>Nothing</code>, then <a href="#PALEOboxes.setvalue!"><code>setvalue!</code></a> will accept an <code>AbstractString</code> and call <code>Base.parse(ParseFromString, strvalue)</code>. This allows eg an enum-valued Parameter to be defined by Parameter{EnumType, EnumType} and implementing parse(EnumType, rawvalue::AbstractString)</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/PALEOtoolkit/PALEOboxes.jl/blob/3a6af11e6f23cc9c2cd1953fc504a48747749f98/src/Parameter.jl#L13-L28">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="PALEOboxes.VecParameter" href="#PALEOboxes.VecParameter"><code>PALEOboxes.VecParameter</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">VecParameter{T, ParseFromString}</code></pre><p>A reaction parameter of type <code>Vector{T}</code>.</p><p>Create using short names <code>ParDoubleVec</code>, <code>ParStringVec</code>.</p><p>Read values as <code>&lt;par&gt;[i]</code>, access raw <code>Vector{T}</code> as <code>&lt;par&gt;.v</code>.</p><p>Set with <a href="#PALEOboxes.setvalue!"><code>setvalue!</code></a>, in config file use standard yaml syntax for a vector eg [1, 2, 3]</p><p>See <a href="#PALEOboxes.Parameter"><code>Parameter</code></a> for additional documentation.</p><p><strong>Implementation</strong></p><p>Implements part of the <code>AbstractVector</code> interface, sufficient to access elements as <code>&lt;par&gt;[i]</code>, and to support iteration eg <code>for v in &lt;par&gt;;  ...; end</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/PALEOtoolkit/PALEOboxes.jl/blob/3a6af11e6f23cc9c2cd1953fc504a48747749f98/src/Parameter.jl#L129-L145">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="PALEOboxes.VecVecParameter" href="#PALEOboxes.VecVecParameter"><code>PALEOboxes.VecVecParameter</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">VecVecParameter{T, ParseFromString}</code></pre><p>A reaction parameter of type Vector{Vector{T}}.</p><p>Create using short names <code>ParDoubleVecVec</code>.</p><p>Read values as <code>&lt;par&gt;.v::Vector{Vector{T}}</code>.</p><p>Set using standard yaml syntax for a vector of vectors eg [[1, 2, 3], [4, 5, 6]]</p><p>See <a href="#PALEOboxes.Parameter"><code>Parameter</code></a> for additional documentation.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/PALEOtoolkit/PALEOboxes.jl/blob/3a6af11e6f23cc9c2cd1953fc504a48747749f98/src/Parameter.jl#L221-L233">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="PALEOboxes.ParametersTuple" href="#PALEOboxes.ParametersTuple"><code>PALEOboxes.ParametersTuple</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">ParametersTuple(parameters::AbstractParameter...) -&gt; NamedTuple
ParametersTuple(parameters) -&gt; NamedTuple</code></pre><p>Create a NamedTuple of Parameters.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/PALEOtoolkit/PALEOboxes.jl/blob/3a6af11e6f23cc9c2cd1953fc504a48747749f98/src/Parameter.jl#L485-L490">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="PALEOboxes.add_par" href="#PALEOboxes.add_par"><code>PALEOboxes.add_par</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">add_par(reaction::AbstractReaction, par::AbstractParameter)
add_par(reaction::AbstractReaction, objectwithpars)</code></pre><p>Add a single parameter or parameters from fields of <code>objectwithpars</code> to a new Reaction.</p><p>Not usually needed: Parameters in <code>pars::ParametersTuple</code><code>will be added automatically, only needed if there are additional Parameters that are not members of</code>pars`.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/PALEOtoolkit/PALEOboxes.jl/blob/3a6af11e6f23cc9c2cd1953fc504a48747749f98/src/Reaction.jl#L263-L271">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="PALEOboxes.setvalue!" href="#PALEOboxes.setvalue!"><code>PALEOboxes.setvalue!</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">setvalue!(par::Parameter, value)</code></pre><p>Set Parameter to <code>value</code>.</p><p>Optionally (if <a href="#PALEOboxes.Parameter"><code>Parameter</code></a> has Type parameter <code>ParseFromString != Nothing</code>) parse <code>value</code> from a String.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/PALEOtoolkit/PALEOboxes.jl/blob/3a6af11e6f23cc9c2cd1953fc504a48747749f98/src/Parameter.jl#L335-L341">source</a></section></article><h2 id="Registering-Reactions-with-the-PALEOboxes-framework"><a class="docs-heading-anchor" href="#Registering-Reactions-with-the-PALEOboxes-framework">Registering Reactions with the PALEOboxes framework</a><a id="Registering-Reactions-with-the-PALEOboxes-framework-1"></a><a class="docs-heading-anchor-permalink" href="#Registering-Reactions-with-the-PALEOboxes-framework" title="Permalink"></a></h2><p>All subtypes of <a href="#PALEOboxes.AbstractReaction"><code>AbstractReaction</code></a> that are present in loaded modules are available to the PALEO framework.  Available Reactions can be listed with <a href="#PALEOboxes.find_reaction"><code>find_reaction</code></a> and <a href="#PALEOboxes.find_all_reactions"><code>find_all_reactions</code></a>.  The default <a href="#PALEOboxes.create_reaction-Tuple{Type{var&quot;#s6&quot;} where var&quot;#s6&quot;&lt;:PALEOboxes.AbstractReaction, PALEOboxes.ReactionBase}"><code>create_reaction</code></a> is called to create Reactions when the model is created (this method can be overridden if needed).</p><article class="docstring"><header><a class="docstring-binding" id="PALEOboxes.create_reaction-Tuple{Type{var&quot;#s6&quot;} where var&quot;#s6&quot;&lt;:PALEOboxes.AbstractReaction, PALEOboxes.ReactionBase}" href="#PALEOboxes.create_reaction-Tuple{Type{var&quot;#s6&quot;} where var&quot;#s6&quot;&lt;:PALEOboxes.AbstractReaction, PALEOboxes.ReactionBase}"><code>PALEOboxes.create_reaction</code></a> — <span class="docstring-category">Method</span></header><section><div><pre><code class="language-julia hljs">create_reaction(ReactionType::Type{&lt;:AbstractReaction}, base::ReactionBase) -&gt; reaction::AbstractReaction</code></pre><p>Create a <code>ReactionType</code> and set <code>base</code> field.</p><p>Default implementation may be overridden to eg set additional fields</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/PALEOtoolkit/PALEOboxes.jl/blob/3a6af11e6f23cc9c2cd1953fc504a48747749f98/src/ReactionFactory.jl#L54-L60">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="PALEOboxes.find_reaction" href="#PALEOboxes.find_reaction"><code>PALEOboxes.find_reaction</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">find_reaction(class::AbstractString) -&gt; ReactionType</code></pre><p>Look up &quot;class&quot; in list of Reactions from <a href="#PALEOboxes.find_all_reactions"><code>find_all_reactions</code></a>, and return  fully-qualified Reaction Type (including module prefixes).</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/PALEOtoolkit/PALEOboxes.jl/blob/3a6af11e6f23cc9c2cd1953fc504a48747749f98/src/ReactionFactory.jl#L39-L44">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="PALEOboxes.find_all_reactions" href="#PALEOboxes.find_all_reactions"><code>PALEOboxes.find_all_reactions</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">find_all_reactions() -&gt; Dict{String, Type}</code></pre><p>Use <code>InteractiveUtils.subtypes(AbstractReaction)</code> to find all currently loaded subtypes off AbstractReaction, and create a <code>Dict</code> with last part of the name of the Type as key (ie without the module prefix) and Type as value.</p><p>Any Types that generate non-unique keys (eg Module1.MyReactionType and Module2.MyReactionType) will generate a warning, and no entry will be added to the Dict (so if this Reaction is present in a config file, it will not be found and will error).</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/PALEOtoolkit/PALEOboxes.jl/blob/3a6af11e6f23cc9c2cd1953fc504a48747749f98/src/ReactionFactory.jl#L4-L14">source</a></section></article><h2 id="Defining-Domain-Grids-and-array-sizes"><a class="docs-heading-anchor" href="#Defining-Domain-Grids-and-array-sizes">Defining Domain Grids and array sizes</a><a id="Defining-Domain-Grids-and-array-sizes-1"></a><a class="docs-heading-anchor-permalink" href="#Defining-Domain-Grids-and-array-sizes" title="Permalink"></a></h2><article class="docstring"><header><a class="docstring-binding" id="PALEOboxes.set_model_geometry" href="#PALEOboxes.set_model_geometry"><code>PALEOboxes.set_model_geometry</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">set_model_geometry(reaction, model)</code></pre><p>Optional: define <a href="../DomainsVariablesFields/#PALEOboxes.Domain"><code>Domain</code></a> <code>grid</code>, <code>data_dims</code>.</p><p>One Reaction per Domain may create a grid (an <a href="../DomainsVariablesFields/#PALEOboxes.AbstractMesh"><code>AbstractMesh</code></a> subtype) and set the <code>domain.grid</code> field.</p><p>Multiple Reactions per domain may call <a href="#PALEOboxes.set_data_dimension!"><code>set_data_dimension!</code></a> to define (different) named data dimensions (eg wavelength grids).</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/PALEOtoolkit/PALEOboxes.jl/blob/3a6af11e6f23cc9c2cd1953fc504a48747749f98/src/Reaction.jl#L213-L221">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="PALEOboxes.set_data_dimension!" href="#PALEOboxes.set_data_dimension!"><code>PALEOboxes.set_data_dimension!</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">set_data_dimension!(domain::Domain, dim::NamedDimension; allow_exists=false)</code></pre><p>Define a Domain data dimension as a <a href="../DomainsVariablesFields/#PALEOboxes.NamedDimension"><code>NamedDimension</code></a></p><p>Variables may then specify data dimensions as a list of names using the <code>:data_dims</code> Variable Attribute.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/PALEOtoolkit/PALEOboxes.jl/blob/3a6af11e6f23cc9c2cd1953fc504a48747749f98/src/Domain.jl#L24-L30">source</a></section></article><h2 id="Creating-and-registering-Reaction-methods"><a class="docs-heading-anchor" href="#Creating-and-registering-Reaction-methods">Creating and registering Reaction methods</a><a id="Creating-and-registering-Reaction-methods-1"></a><a class="docs-heading-anchor-permalink" href="#Creating-and-registering-Reaction-methods" title="Permalink"></a></h2><p>All Reactions should implement <a href="#PALEOboxes.register_methods!"><code>register_methods!</code></a>, and may optionally implement <a href="#PALEOboxes.register_dynamic_methods!"><code>register_dynamic_methods!</code></a>.</p><article class="docstring"><header><a class="docstring-binding" id="PALEOboxes.register_methods!" href="#PALEOboxes.register_methods!"><code>PALEOboxes.register_methods!</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">register_methods!(reaction)
register_methods!(reaction, model)</code></pre><p>Add <a href="#PALEOboxes.ReactionMethod"><code>ReactionMethod</code></a>s, using <a href="#PALEOboxes.add_method_setup!"><code>add_method_setup!</code></a>, <a href="#PALEOboxes.add_method_initialize!"><code>add_method_initialize!</code></a> <a href="#PALEOboxes.add_method_do!"><code>add_method_do!</code></a>. See also <a href="#PALEOboxes.register_dynamic_methods!"><code>register_dynamic_methods!</code></a>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/PALEOtoolkit/PALEOboxes.jl/blob/3a6af11e6f23cc9c2cd1953fc504a48747749f98/src/Reaction.jl#L234-L240">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="PALEOboxes.register_dynamic_methods!" href="#PALEOboxes.register_dynamic_methods!"><code>PALEOboxes.register_dynamic_methods!</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">register_dynamic_methods!(reaction)
register_dynamic_methods!(reaction, model)</code></pre><p>Optional: called after first variable link pass, to add <a href="#PALEOboxes.ReactionMethod"><code>ReactionMethod</code></a>s that depend on Variables generated by other Reactions (see <a href="#PALEOboxes.register_methods!"><code>register_methods!</code></a>).</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/PALEOtoolkit/PALEOboxes.jl/blob/3a6af11e6f23cc9c2cd1953fc504a48747749f98/src/Reaction.jl#L246-L253">source</a></section></article><p>These methods should then define one or more <a href="#PALEOboxes.ReactionMethod"><code>ReactionMethod</code></a>s, which requires:</p><ul><li>Defining collections of <a href="#PALEOboxes.VariableReaction"><code>VariableReaction</code></a>s (see <a href="#Defining-VariableReactions">Defining VariableReactions</a>,  <a href="#Defining-collections-of-VariableReactions">Defining collections of VariableReactions</a>).</li><li>Implementing a function to iterate over model cells and calculate the required fluxes etc (see <a href="#Implementing-method-functions">Implementing method functions</a>)</li><li>Adding methods (see <a href="#Adding-ReactionMethods">Adding ReactionMethods</a>).</li></ul><p>In addition it is possible to add <a href="#Predefined-ReactionMethods">Predefined ReactionMethods</a> for some common operations (Variable initialisation, calculating totals, etc).</p><h3 id="Defining-VariableReactions"><a class="docs-heading-anchor" href="#Defining-VariableReactions">Defining VariableReactions</a><a id="Defining-VariableReactions-1"></a><a class="docs-heading-anchor-permalink" href="#Defining-VariableReactions" title="Permalink"></a></h3><article class="docstring"><header><a class="docstring-binding" id="PALEOboxes.VariableReaction" href="#PALEOboxes.VariableReaction"><code>PALEOboxes.VariableReaction</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">VariableReaction(VT, localname =&gt; link_namestr, units, description; attributes=Tuple()) -&gt; VariableReaction{VT}
VariableReaction(VT, linklocal_namestr, units, description; attributes=Tuple()) -&gt; VariableReaction{VT}    

VarProp, VarPropScalar, VarPropStateIndep, VarPropScalarStateIndep -&gt; VariableReaction{VT_ReactProperty}
VarDep, VarDepColumn, VarDepScalar, VarDepStateIndep, VarDepColumnStateIndep, VarDepScalarStateIndep -&gt; VariableReaction{VT_ReactDependency}
VarTarget, VarTargetScalar -&gt; VariableReaction{VT_ReactTarget}
VarContrib, VarContribColumn, VarContribScalar -&gt; VariableReaction{VT_ReactContributor}
VarStateExplicit, VarStateExplicitScalar -&gt; VariableReaction{VT_ReactDependency}
VarDeriv, VarDerivScalar -&gt; VariableReaction{VT_ReactContributor}
VarState, VarStateScalar -&gt; VariableReaction{VT_ReactDependency}
VarConstraint, VarConstraintScalar -&gt; VariableReaction{VT_ReactDependency}

[deprecated] VariableReaction(VT, localname, units, description; link_namestr, attributes=Tuple()) -&gt; VariableReaction{VT}</code></pre><p>Reaction view on a model variable.</p><p>Reactions define <a href="#PALEOboxes.AbstractVarList"><code>AbstractVarList</code></a>s of <code>VariableReaction</code>s when creating a <a href="#PALEOboxes.ReactionMethod"><code>ReactionMethod</code></a>.  Within a <code>ReactionMethod</code>, a <code>VariableReaction</code> is referred to by <code>localname</code>. When the model is initialised,  <a href="../DomainsVariablesFields/#PALEOboxes.VariableDomain"><code>VariableDomain</code></a> variables are created that link together <code>VariableReaction</code>s with the same <code>link_namestr</code>, and data Arrays are allocated. <code>views</code> on the <code>VariableDomain</code> data Arrays are then passed to the <a href="#PALEOboxes.ReactionMethod"><code>ReactionMethod</code></a> function at each timestep.</p><p><strong>Subtypes</strong></p><p>The Type parameter <code>VT</code> is one of <code>VT_ReactProperty</code>, <code>VT_ReactDependency</code>, <code>VT_ReactContributor</code>, <code>VT_ReactTarget</code>, where  short names are defined for convenience:</p><pre><code class="nohighlight hljs">const VarPropT        = VariableReaction{VT_ReactProperty}
const VarDepT         = VariableReaction{VT_ReactDependency}
const VarTargetT      = VariableReaction{VT_ReactTarget}
const VarContribT     = VariableReaction{VT_ReactContributor}</code></pre><p>There are two pairings of <code>VariableReaction</code>s with <a href="../DomainsVariablesFields/#PALEOboxes.VariableDomain"><code>VariableDomain</code></a>s:</p><ul><li>Reaction Property and Dependency Variables, linked to a <a href="../DomainsVariablesFields/#PALEOboxes.VariableDomPropDep"><code>VariableDomPropDep</code></a>. These are used to represent   a quantity calculated in one Reaction that is then used by other Reactions.</li><li>Reaction Target and Contributor Variables, linked to a <a href="../DomainsVariablesFields/#PALEOboxes.VariableDomContribTarget"><code>VariableDomContribTarget</code></a>. These are used to represent   a flux-like quantity, with one Reaction definining the Target and multiple Reactions adding contributions.</li></ul><p><strong>Variable Attributes and constructor convenience functions</strong></p><p>Variable attributes are used to define Variable <code>:space</code> <a href="../DomainsVariablesFields/#PALEOboxes.AbstractSpace"><code>AbstractSpace</code></a> (scalar, per-cell, etc) and data content <code>:field_data</code> <a href="../DomainsVariablesFields/#PALEOboxes.AbstractData"><code>AbstractData</code></a>,  and to label state Variables for use by numerical solvers. </p><p><code>VariableReaction</code> is usually not called directly, instead convenience functions are defined that provide commonly-used combinations of <code>VT</code> and <code>attributes</code>:</p><table><tr><th style="text-align: right">short name</th><th style="text-align: right">VT</th><th style="text-align: right">attributes</th><th style="text-align: right"></th><th style="text-align: right"></th><th style="text-align: right"></th><th style="text-align: right"></th><th style="text-align: right"></th></tr><tr><td style="text-align: right"></td><td style="text-align: right"></td><td style="text-align: right"><code>:space</code></td><td style="text-align: right"><code>:field_data</code></td><td style="text-align: right"><code>:vfunction</code></td><td style="text-align: right"><code>:initialize_to_zero</code></td><td style="text-align: right"><code>:datatype</code></td><td style="text-align: right"><code>:is_constant</code></td></tr><tr><td style="text-align: right"></td><td style="text-align: right"></td><td style="text-align: right"></td><td style="text-align: right"></td><td style="text-align: right"></td><td style="text-align: right"></td><td style="text-align: right"></td><td style="text-align: right"></td></tr><tr><td style="text-align: right"><code>VarProp</code></td><td style="text-align: right"><code>VT_ReactProperty</code></td><td style="text-align: right"><code>CellSpace</code></td><td style="text-align: right"><code>ScalarData</code></td><td style="text-align: right"><code>VF_Undefined</code></td><td style="text-align: right">-</td><td style="text-align: right">-</td><td style="text-align: right">false</td></tr><tr><td style="text-align: right"><code>VarPropScalar</code></td><td style="text-align: right"><code>VT_ReactProperty</code></td><td style="text-align: right"><code>ScalarSpace</code></td><td style="text-align: right"><code>ScalarData</code></td><td style="text-align: right"><code>VF_Undefined</code></td><td style="text-align: right">-</td><td style="text-align: right">-</td><td style="text-align: right">false</td></tr><tr><td style="text-align: right"><code>VarPropStateIndep</code></td><td style="text-align: right"><code>VT_ReactProperty</code></td><td style="text-align: right"><code>CellSpace</code></td><td style="text-align: right"><code>ScalarData</code></td><td style="text-align: right"><code>VF_Undefined</code></td><td style="text-align: right">-</td><td style="text-align: right"><code>Float64</code></td><td style="text-align: right">true</td></tr><tr><td style="text-align: right"><code>VarPropScalarStateIndep</code></td><td style="text-align: right"><code>VT_ReactProperty</code></td><td style="text-align: right"><code>ScalarSpace</code></td><td style="text-align: right"><code>ScalarData</code></td><td style="text-align: right"><code>VF_Undefined</code></td><td style="text-align: right">-</td><td style="text-align: right"><code>Float64</code></td><td style="text-align: right">true</td></tr><tr><td style="text-align: right"></td><td style="text-align: right"></td><td style="text-align: right"></td><td style="text-align: right"></td><td style="text-align: right"></td><td style="text-align: right"></td><td style="text-align: right"></td><td style="text-align: right"></td></tr><tr><td style="text-align: right"><code>VarDep</code></td><td style="text-align: right"><code>VT_ReactDependency</code></td><td style="text-align: right"><code>CellSpace</code></td><td style="text-align: right"><code>UndefinedData</code></td><td style="text-align: right"><code>VF_Undefined</code></td><td style="text-align: right">-</td><td style="text-align: right">-</td><td style="text-align: right">false</td></tr><tr><td style="text-align: right"><code>VarDepColumn</code></td><td style="text-align: right"><code>VT_ReactDependency</code></td><td style="text-align: right"><code>ColumnSpace</code></td><td style="text-align: right"><code>UndefinedData</code></td><td style="text-align: right"><code>VF_Undefined</code></td><td style="text-align: right">-</td><td style="text-align: right">-</td><td style="text-align: right">false</td></tr><tr><td style="text-align: right"><code>VarDepScalar</code></td><td style="text-align: right"><code>VT_ReactDependency</code></td><td style="text-align: right"><code>ScalarSpace</code></td><td style="text-align: right"><code>UndefinedData</code></td><td style="text-align: right"><code>VF_Undefined</code></td><td style="text-align: right">-</td><td style="text-align: right">-</td><td style="text-align: right">false</td></tr><tr><td style="text-align: right"><code>VarDepStateIndep</code></td><td style="text-align: right"><code>VT_ReactDependency</code></td><td style="text-align: right"><code>CellSpace</code></td><td style="text-align: right"><code>UndefinedData</code></td><td style="text-align: right"><code>VF_Undefined</code></td><td style="text-align: right">-</td><td style="text-align: right"><code>Float64</code></td><td style="text-align: right">true</td></tr><tr><td style="text-align: right"><code>VarDepColumnStateIndep</code></td><td style="text-align: right"><code>VT_ReactDependency</code></td><td style="text-align: right"><code>ColumnSpace</code></td><td style="text-align: right"><code>UndefinedData</code></td><td style="text-align: right"><code>VF_Undefined</code></td><td style="text-align: right">-</td><td style="text-align: right"><code>Float64</code></td><td style="text-align: right">true</td></tr><tr><td style="text-align: right"><code>VarDepScalarStateIndep</code></td><td style="text-align: right"><code>VT_ReactDependency</code></td><td style="text-align: right"><code>ScalarSpace</code></td><td style="text-align: right"><code>UndefinedData</code></td><td style="text-align: right"><code>VF_Undefined</code></td><td style="text-align: right">-</td><td style="text-align: right"><code>Float64</code></td><td style="text-align: right">true</td></tr><tr><td style="text-align: right"></td><td style="text-align: right"></td><td style="text-align: right"></td><td style="text-align: right"></td><td style="text-align: right"></td><td style="text-align: right"></td><td style="text-align: right"></td><td style="text-align: right"></td></tr><tr><td style="text-align: right"><code>VarTarget</code></td><td style="text-align: right"><code>VT_ReactTarget</code></td><td style="text-align: right"><code>CellSpace</code></td><td style="text-align: right"><code>ScalarData</code></td><td style="text-align: right"><code>VF_Undefined</code></td><td style="text-align: right"><code>true</code></td><td style="text-align: right">-</td><td style="text-align: right">false</td></tr><tr><td style="text-align: right"><code>VarTargetScalar</code></td><td style="text-align: right"><code>VT_ReactTarget</code></td><td style="text-align: right"><code>ScalarSpace</code></td><td style="text-align: right"><code>ScalarData</code></td><td style="text-align: right"><code>VF_Undefined</code></td><td style="text-align: right"><code>true</code></td><td style="text-align: right">-</td><td style="text-align: right">false</td></tr><tr><td style="text-align: right"></td><td style="text-align: right"></td><td style="text-align: right"></td><td style="text-align: right"></td><td style="text-align: right"></td><td style="text-align: right"></td><td style="text-align: right"></td><td style="text-align: right"></td></tr><tr><td style="text-align: right"><code>VarContrib</code></td><td style="text-align: right"><code>VT_ReactContributor</code></td><td style="text-align: right"><code>CellSpace</code></td><td style="text-align: right"><code>UndefinedData</code></td><td style="text-align: right"><code>VF_Undefined</code></td><td style="text-align: right">-</td><td style="text-align: right">-</td><td style="text-align: right">false</td></tr><tr><td style="text-align: right"><code>VarContribColumn</code></td><td style="text-align: right"><code>VT_ReactContributor</code></td><td style="text-align: right"><code>ColumnSpace</code></td><td style="text-align: right"><code>UndefinedData</code></td><td style="text-align: right"><code>VF_Undefined</code></td><td style="text-align: right">-</td><td style="text-align: right">-</td><td style="text-align: right">false</td></tr><tr><td style="text-align: right"><code>VarContribScalar</code></td><td style="text-align: right"><code>VT_ReactContributor</code></td><td style="text-align: right"><code>ScalarSpace</code></td><td style="text-align: right"><code>UndefinedData</code></td><td style="text-align: right"><code>VF_Undefined</code></td><td style="text-align: right">-</td><td style="text-align: right">-</td><td style="text-align: right">false</td></tr><tr><td style="text-align: right"></td><td style="text-align: right"></td><td style="text-align: right"></td><td style="text-align: right"></td><td style="text-align: right"></td><td style="text-align: right"></td><td style="text-align: right"></td><td style="text-align: right"></td></tr><tr><td style="text-align: right"><code>VarStateExplicit</code></td><td style="text-align: right"><code>VT_ReactDependency</code></td><td style="text-align: right"><code>CellSpace</code></td><td style="text-align: right"><code>ScalarData</code></td><td style="text-align: right"><code>VF_StateExplicit</code></td><td style="text-align: right">-</td><td style="text-align: right">-</td><td style="text-align: right">false</td></tr><tr><td style="text-align: right"><code>VarStateExplicitScalar</code></td><td style="text-align: right"><code>VT_ReactDependency</code></td><td style="text-align: right"><code>ScalarSpace</code></td><td style="text-align: right"><code>ScalarData</code></td><td style="text-align: right"><code>VF_StateExplicit</code></td><td style="text-align: right">-</td><td style="text-align: right">-</td><td style="text-align: right">false</td></tr><tr><td style="text-align: right"><code>VarDeriv</code></td><td style="text-align: right"><code>VT_ReactContributor</code></td><td style="text-align: right"><code>CellSpace</code></td><td style="text-align: right"><code>ScalarData</code></td><td style="text-align: right"><code>VF_Deriv</code></td><td style="text-align: right"><code>true</code></td><td style="text-align: right">-</td><td style="text-align: right">false</td></tr><tr><td style="text-align: right"><code>VarDerivScalar</code></td><td style="text-align: right"><code>VT_ReactContributor</code></td><td style="text-align: right"><code>ScalarSpace</code></td><td style="text-align: right"><code>ScalarData</code></td><td style="text-align: right"><code>VF_Deriv</code></td><td style="text-align: right"><code>true</code></td><td style="text-align: right">-</td><td style="text-align: right">false</td></tr><tr><td style="text-align: right"></td><td style="text-align: right"></td><td style="text-align: right"></td><td style="text-align: right"></td><td style="text-align: right"></td><td style="text-align: right"></td><td style="text-align: right"></td><td style="text-align: right"></td></tr><tr><td style="text-align: right"><code>VarState</code></td><td style="text-align: right"><code>VT_ReactDependency</code></td><td style="text-align: right"><code>CellSpace</code></td><td style="text-align: right"><code>ScalarData</code></td><td style="text-align: right"><code>VF_State</code></td><td style="text-align: right">-</td><td style="text-align: right">-</td><td style="text-align: right">false</td></tr><tr><td style="text-align: right"><code>VarStateScalar</code></td><td style="text-align: right"><code>VT_ReactDependency</code></td><td style="text-align: right"><code>ScalarSpace</code></td><td style="text-align: right"><code>ScalarData</code></td><td style="text-align: right"><code>VF_State</code></td><td style="text-align: right">-</td><td style="text-align: right">-</td><td style="text-align: right">false</td></tr><tr><td style="text-align: right"><code>VarConstraint</code></td><td style="text-align: right"><code>VT_ReactContributor</code></td><td style="text-align: right"><code>CellSpace</code></td><td style="text-align: right"><code>ScalarData</code></td><td style="text-align: right"><code>VF_Constraint</code></td><td style="text-align: right"><code>true</code></td><td style="text-align: right">-</td><td style="text-align: right">false</td></tr><tr><td style="text-align: right"><code>VarConstraintScalar</code></td><td style="text-align: right"><code>VT_ReactContributor</code></td><td style="text-align: right"><code>ScalarSpace</code></td><td style="text-align: right"><code>ScalarData</code></td><td style="text-align: right"><code>VF_Constraint</code></td><td style="text-align: right"><code>true</code></td><td style="text-align: right">-</td><td style="text-align: right">false</td></tr></table><p>This illustrates some general principles for the use of attributes:</p><ul><li>All Variables must define the <code>:space</code> VariableAttribute (a subtype of <a href="../DomainsVariablesFields/#PALEOboxes.AbstractSpace"><code>AbstractSpace</code></a>) to specify whether they are Domain scalars, per-cell quantities, etc. This is used to define array dimensions, and to check that dimensions match when variables are linked.</li><li>The <code>:field_data</code> attribute (a subtype of <a href="../DomainsVariablesFields/#PALEOboxes.AbstractData"><code>AbstractData</code></a>) specifies the quantity that Property and Target Variables represent. This defaults to  <code>ScalarData</code> to represent a scalar value. To eg represent a single isotope the <code>:field_data</code> attribute should be set to <code>IsotopeLinear</code>. Dependency and Contributor Variables with <code>:field_data = UndefinedData</code> then acquire this value when they are linked, or may specify <code>:field_data</code> to constrain allowed links.</li><li>The <code>:initialize_to_zero</code> attribute is set for Target variables, this is than used (by the ReactionMethod created by <a href="#PALEOboxes.add_method_initialize_zero_vars_default!"><code>add_method_initialize_zero_vars_default!</code></a>) to identify variables that should be initialised to zero at the start of each timestep.</li><li>The <code>:vfunction</code> attribute is used to label state Variables and corresponding time derivatives, for access by a numerical solver.<ul><li>An ODE-like combination of a state variable and time derivative are defined by a paired <code>VarStateExplicit</code> and <code>VarDeriv</code>. Note that that these are just <code>VarDep</code> and <code>VarContrib</code> with the <code>:vfunction</code> attribute set, and that there is no <code>VarProp</code> and <code>VarTarget</code> defined in the model (these are effectively provided by the numerical solver). The pairing is defined by the naming convention of <code>varname</code> and <code>varname_sms</code>.</li><li>An algebraic constraint (for a DAE) is defined by a <code>VarState</code> and <code>VarConstraint</code>. Note that that these are just <code>VarDep</code> and <code>VarContrib</code> with the <code>:vfunction</code> attribute set, and that there is no <code>VarProp</code> and <code>VarTarget</code> defined in the model (these are effectively provided by the numerical solver). These variables are not paired.</li><li>The :initialize<em>to</em>zero attribute is also set for Contributor variables VarDeriv and VarConstraint (as there is no corresponding Target variable in the model).</li><li>The :field_data attribute should be set on labelled state etc Variables (as there are no corresponding Property or Target variables in the model to define this).</li></ul></li><li>The <code>:is_constant</code> attribute is used to identify constant Property Variables (not modified after initialisation). A Dependency Variable with :is_constant = true can only link to a constant Property Variable.</li><li>The <code>:datatype</code> attribute is used both to provide a concrete datatype for constant Variables, and to exclude a non-constant Variable from automatic differentiation (TODO document that usage).</li></ul><p>Additional attributes can be specified to provide model-specific information, with defaults defined in the Reaction .jl code that can often then be overridden in the .yaml configuration file, see <a href="../DomainsVariablesFields/#PALEOboxes.StandardAttributes"><code>StandardAttributes</code></a>. Examples include:</p><ul><li><code>:initial_value</code>, <code>:norm_value</code>, <code>:initial_delta</code> for state variables or constant variables. NB: the Reaction creating these variables is responsible for implementing a setup method to read the attributes and set the variable data array appropriately at model initialisation.</li><li>An <code>:advect</code> attribute is used to label tracer variables to indicate that they should have advective transport applied by a transport Reaction included in the model.</li></ul><p>NB: after Variables are linked to Domain Variables, the attributes used are those from the <code>master</code> Variable (either a Property or Target variable, or a labelled state variable Dependency or Contributor with no corresponding Property or Target). Additional attributes must therefore be set on this master Variable.</p><p><strong>Specifying links</strong></p><p><code>localname</code> identifies the <code>VariableReaction</code> within the <code>Reaction</code>, and can be used to set <code>variable_attributes:</code> and <code>variable_links:</code> in the .yaml configuration file.</p><p><code>linkreq_domain.linkreq_subdomain.linkreq_name</code> defines the Domain, Subdomain and name for run-time linking to <a href="../DomainsVariablesFields/#PALEOboxes.VariableDomain"><code>VariableDomain</code></a> variables. </p><p><strong>Arguments</strong></p><ul><li><code>VT::VariableType</code>:  one of <code>VT_ReactProperty</code>, <code>VT_ReactDependency</code>, <code>VT_ReactContributor</code>, <code>VT_ReactTarget</code></li><li><code>localname::AbstractString</code>: Reaction-local Variable name</li><li><code>link_namestr::AbstractString</code>: <code>&lt;linkreq_domain&gt;.[linkreq_subdomain.]linkreq_name</code>. Parsed by <a href="#PALEOboxes.parse_variablereaction_namestr"><code>parse_variablereaction_namestr</code></a> to define the requested linking to <code>Domain</code> Variable.</li><li><code>linklocal_namestr::AbstractString</code>:  <code>&lt;linkreq_domain&gt;.[linkreq_subdomain.]localname</code>. Convenience form to define both <code>localname</code> and requested linking to Domain Variable, for the common case where <code>linkreq_name == localname</code>.</li><li><code>units::AbstractString</code>: units (&quot;&quot; if not applicable)</li><li><code>description::AbstractString</code>: text describing the variable</li></ul><p><strong>Keywords</strong></p><ul><li><code>attributes::Tuple(:attrb1name=&gt;attrb1value, :attrb2name=&gt;attrb2value, ...)</code>:  variable attributes, see <a href="../DomainsVariablesFields/#PALEOboxes.StandardAttributes"><code>StandardAttributes</code></a>, <a href="#PALEOboxes.set_attribute!"><code>set_attribute!</code></a>, <a href="../DomainsVariablesFields/#PALEOboxes.get_attribute"><code>get_attribute</code></a></li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/PALEOtoolkit/PALEOboxes.jl/blob/3a6af11e6f23cc9c2cd1953fc504a48747749f98/src/VariableReaction.jl#L389-L522">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="PALEOboxes.parse_variablereaction_namestr" href="#PALEOboxes.parse_variablereaction_namestr"><code>PALEOboxes.parse_variablereaction_namestr</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">parse_variablereaction_namestr(linkstr) 
    -&gt; (linkreq_domain, linkreq_subdomain, linkreq_name, link_optional)</code></pre><p>Parse a linkstr into component parts.</p><p><code>linkstr</code> is of format: <code>[(][&lt;linkreq_domain&gt;.][&lt;linkreq_subdomain&gt;.]&lt;linkreq_name&gt;[)]</code></p><ul><li>Optional brackets <code>( ... )</code> set <code>link_optional=true</code></li><li><code>linkreq_name</code> may contain <code>%reaction%</code> which will later be substituted with <code>&lt;Reaction name&gt;/</code></li></ul><p><strong>Examples:</strong></p><pre><code class="language-julia-repl hljs">julia&gt; PALEOboxes.parse_variablereaction_namestr(&quot;foo&quot;)  # Common case eg for a property that should be public
(&quot;&quot;, &quot;&quot;, &quot;foo&quot;, false)

julia&gt; PALEOboxes.parse_variablereaction_namestr(&quot;%reaction%foo&quot;)  # Reaction-private by default
(&quot;&quot;, &quot;&quot;, &quot;%reaction%foo&quot;, false)

julia&gt; PALEOboxes.parse_variablereaction_namestr(&quot;ocean.foo&quot;)  # Request link to variable of same name in ocean Domain
(&quot;ocean&quot;, &quot;&quot;, &quot;foo&quot;, false)

julia&gt; PALEOboxes.parse_variablereaction_namestr(&quot;(ocean.oceansurface.goo)&quot;) # Full syntax
(&quot;ocean&quot;, &quot;oceansurface&quot;, &quot;goo&quot;, true)</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/PALEOtoolkit/PALEOboxes.jl/blob/3a6af11e6f23cc9c2cd1953fc504a48747749f98/src/VariableReaction.jl#L838-L862">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="PALEOboxes.set_attribute!" href="#PALEOboxes.set_attribute!"><code>PALEOboxes.set_attribute!</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">set_attribute!(var::VariableBase, name::Symbol, value, allow_create=false) -&gt; var</code></pre><p>Set Variable attribute.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/PALEOtoolkit/PALEOboxes.jl/blob/3a6af11e6f23cc9c2cd1953fc504a48747749f98/src/VariableAttributes.jl#L7-L11">source</a></section></article><h3 id="Defining-collections-of-VariableReactions"><a class="docs-heading-anchor" href="#Defining-collections-of-VariableReactions">Defining collections of VariableReactions</a><a id="Defining-collections-of-VariableReactions-1"></a><a class="docs-heading-anchor-permalink" href="#Defining-collections-of-VariableReactions" title="Permalink"></a></h3><article class="docstring"><header><a class="docstring-binding" id="PALEOboxes.AbstractVarList" href="#PALEOboxes.AbstractVarList"><code>PALEOboxes.AbstractVarList</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">AbstractVarList</code></pre><p>Variables required by a <a href="#PALEOboxes.ReactionMethod"><code>ReactionMethod</code></a> <code>methodfn</code> are specified by  a Tuple of VarList_xxx &lt;: AbstractVarList, each containing a collection of <a href="#PALEOboxes.VariableReaction"><code>VariableReaction</code></a>.</p><p>These are then converted (by the <a href="#PALEOboxes.create_accessors"><code>create_accessors</code></a> method) to a corresponding Tuple of collections of views on Domain data arrays , which are then be passed to the <a href="#PALEOboxes.ReactionMethod"><code>ReactionMethod</code></a> <code>methodfn</code>.</p><p><strong>Implementation</strong></p><p>Subtypes of <code>AbstractVarList</code> should implement:</p><ul><li>a constructor that takes a collection of VariableReactions</li><li><a href="#PALEOboxes.create_accessors"><code>create_accessors</code></a>, returning the views on Domain data arrays in a subtype-specific collection.</li><li><a href="../Solver API/#PALEOboxes.get_variables"><code>get_variables</code></a>, returning the collection of VariableReactions (as a flat list).</li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/PALEOtoolkit/PALEOboxes.jl/blob/3a6af11e6f23cc9c2cd1953fc504a48747749f98/src/VariableReaction.jl#L417-L431">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="PALEOboxes.VarList_single" href="#PALEOboxes.VarList_single"><code>PALEOboxes.VarList_single</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">VarList_single(var; components=false) -&gt; VarList_single</code></pre><p>Create a <code>VarList_single</code> describing a single <code>VariableReaction</code>, <code>create_accessors</code> will then return a single accessor.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/PALEOtoolkit/PALEOboxes.jl/blob/3a6af11e6f23cc9c2cd1953fc504a48747749f98/src/VariableReaction.jl#L451-L456">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="PALEOboxes.VarList_namedtuple" href="#PALEOboxes.VarList_namedtuple"><code>PALEOboxes.VarList_namedtuple</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">VarList_namedtuple(varcollection; components=false) -&gt; VarList_namedtuple</code></pre><p>Create a <code>VarList_namedtuple</code> describing a collection of <code>VariableReaction</code>s, <code>create_accessors</code> will then return a NamedTuple with field names = <code>VariableReaction.localname</code> and field values = corresponding data arrays.</p><p>If <code>components = true</code>, each NamedTuple field will be a Vector of data array components.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/PALEOtoolkit/PALEOboxes.jl/blob/3a6af11e6f23cc9c2cd1953fc504a48747749f98/src/VariableReaction.jl#L512-L520">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="PALEOboxes.VarList_tuple" href="#PALEOboxes.VarList_tuple"><code>PALEOboxes.VarList_tuple</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">VarList_tuple(varcollection; components=false) -&gt; VarList_tuple</code></pre><p>Create a <code>VarList_tuple</code> describing a collection of <code>VariableReaction</code>s, <code>create_accessors</code> will then return a Tuple of data arrays.</p><p>If <code>components = true</code>, each Tuple field will be a Vector of data array components.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/PALEOtoolkit/PALEOboxes.jl/blob/3a6af11e6f23cc9c2cd1953fc504a48747749f98/src/VariableReaction.jl#L553-L560">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="PALEOboxes.VarList_vector" href="#PALEOboxes.VarList_vector"><code>PALEOboxes.VarList_vector</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">VarList_vector(varcollection; components=false, forceview=false) -&gt; VarList_vector</code></pre><p>Create a <code>VarList_vector</code> describing a collection of <code>VariableReaction</code>s, <code>create_accessors</code> will then return a Vector of data arrays.</p><p>If <code>components = true</code>, each Vector element will be a Vector of data array components.</p><p>If <code>forceview = true</code>, each accessor will be a 1-D <code>view</code> to help type stability, even if this is redundant (ie no <code>view</code> required, v::Vector -&gt; view(v, 1:length(v)))</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/PALEOtoolkit/PALEOboxes.jl/blob/3a6af11e6f23cc9c2cd1953fc504a48747749f98/src/VariableReaction.jl#L572-L582">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="PALEOboxes.VarList_vvector" href="#PALEOboxes.VarList_vvector"><code>PALEOboxes.VarList_vvector</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">VarList_vvector(Vector{Vector{VariableReaction}}::vars; components=false) -&gt; VarList_vvector</code></pre><p>Create a <code>VarList_vvector</code> describing a Vector of Vectors of <code>VariableReaction</code>s, <code>create_accessors</code> will then return a Vector of Vectors of data arrays.</p><p>If <code>components = true</code>, each Vector of Vectors element will be a Vector of data array components.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/PALEOtoolkit/PALEOboxes.jl/blob/3a6af11e6f23cc9c2cd1953fc504a48747749f98/src/VariableReaction.jl#L597-L604">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="PALEOboxes.VarList_nothing" href="#PALEOboxes.VarList_nothing"><code>PALEOboxes.VarList_nothing</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">VarList_nothing() -&gt; VarList_nothing</code></pre><p>Create a placeholder for a missing/unavailable VariableReaction. <code>create_accessors</code> will then return <code>nothing</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/PALEOtoolkit/PALEOboxes.jl/blob/3a6af11e6f23cc9c2cd1953fc504a48747749f98/src/VariableReaction.jl#L616-L621">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="PALEOboxes.VarList_tuple_nothing" href="#PALEOboxes.VarList_tuple_nothing"><code>PALEOboxes.VarList_tuple_nothing</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">VarList_tuple_nothing(nvar) -&gt; VarList_tuple_nothing</code></pre><p>Create a placeholder for <code>nvar</code> missing/unavailable VariableReactions. <code>create_accessors</code> will then return an <code>NTuple{nvar, Nothing}</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/PALEOtoolkit/PALEOboxes.jl/blob/3a6af11e6f23cc9c2cd1953fc504a48747749f98/src/VariableReaction.jl#L628-L633">source</a></section></article><h3 id="Implementing-method-functions"><a class="docs-heading-anchor" href="#Implementing-method-functions">Implementing method functions</a><a id="Implementing-method-functions-1"></a><a class="docs-heading-anchor-permalink" href="#Implementing-method-functions" title="Permalink"></a></h3><p>Reaction method functions should iterate over the cells in the Domain supplied by <code>cellrange</code> argument and calculate appropriate biogeochemical fluxes etc (which may include the model time derivative and any intermediate or diagnostic output).</p><h4 id="Iterating-over-cells"><a class="docs-heading-anchor" href="#Iterating-over-cells">Iterating over cells</a><a id="Iterating-over-cells-1"></a><a class="docs-heading-anchor-permalink" href="#Iterating-over-cells" title="Permalink"></a></h4><p>The simplest case is a method function that iterates over individual cells, with skeleton form:</p><pre><code class="nohighlight hljs">function do_something_cellwise(m::PB.AbstractReactionMethod, pars, (vars, ), cellrange::PB.AbstractCellRange, deltat)

    @inbounds for i in cellrange.indices
        vars.A[i]  = something*vars.B[i]*vars.C[i]  # in general A is some function of B, C, etc
        # etc
    end

    return nothing
end</code></pre><h4 id="Iterating-over-cells-in-columns"><a class="docs-heading-anchor" href="#Iterating-over-cells-in-columns">Iterating over cells in columns</a><a id="Iterating-over-cells-in-columns-1"></a><a class="docs-heading-anchor-permalink" href="#Iterating-over-cells-in-columns" title="Permalink"></a></h4><p>If necessary (eg to calculate vertical transport), provided the model grid and cellrange allow, it is possible to iterate over columns and then cells within columns (in order from top to bottom):</p><pre><code class="nohighlight hljs">function do_something_columnwise(m::PB.AbstractReactionMethod, pars, (vars, ), cellrange::PB.AbstractCellRange, deltat)

    @inbounds for (icol, colindices) in cellrange.columns
        accum = zero(vars.A[first(colindices)]) # accumulator of appropriate type
        for i in colindices  # order is top to bottom
            accum += vars.A[i]
            vars.C[i] = accum  # C = sum of A in cells above                 
            # etc
        end

        vars.floor_C[icol] = vars.C[last(colindices)] # assumes model has a floor domain with one floor cell per column in the interior domain
    end

    return nothing
end</code></pre><p>Iteration from bottom to top within a column can be implemented using <code>Iterators.reverse</code>, eg</p><pre><code class="nohighlight hljs">function do_something_columnwise(m::PB.AbstractReactionMethod, pars, (vars, ), cellrange::PB.AbstractCellRange, deltat)
    @inbounds for (icol, colindices) in cellrange.columns
        colreverse = Iterators.reverse(colindices)
        for i in colreverse  # order is bottom to top
            # etc
        end
    end

    return nothing
end</code></pre><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>The method function shouldn&#39;t make any assumptions about <code>colindices</code> other than that it is a list of indices ordered from top to bottom in a column.  Depending on the grid in use, the indices may not be contiguous, and may not be integers.</p></div></div><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>The example above made the additional assumption that a <code>floor</code> domain had been defined (containing Variable <code>floor_C</code>) with one floor cell per column. This is determined by the model configuration, and is not true in general.</p></div></div><p>In rare cases where it is necessary to operate on a Vector representing a quantity for the whole column (rather than just iterate through it), this can be implemented using <code>view</code>, eg</p><pre><code class="nohighlight hljs">function do_something_columnwise(m::PB.AbstractReactionMethod, pars, (vars, ), cellrange::PB.AbstractCellRange, deltat)
    @inbounds for (icol, colindices) in cellrange.columns
        A_col = view(vars.A, colindices)  # A_col is an AbstractVector with contiguous indices 1:length(colindices)
        B_col = view(vars.B, colindices)  # B_col is an AbstractVector with contiguous indices 1:length(colindices)
        
        # do something that needs a vector of cells for a whole column
    end

    return nothing
end</code></pre><h4 id="Optimising-loops-over-cells-using-explicit-SIMD-instructions"><a class="docs-heading-anchor" href="#Optimising-loops-over-cells-using-explicit-SIMD-instructions">Optimising loops over cells using explicit SIMD instructions</a><a id="Optimising-loops-over-cells-using-explicit-SIMD-instructions-1"></a><a class="docs-heading-anchor-permalink" href="#Optimising-loops-over-cells-using-explicit-SIMD-instructions" title="Permalink"></a></h4><p>Reactions with simple loops over <code>cellindices</code> that implement time-consuming per-cell calculations  may be optimised by using explicit SIMD instructions.</p><article class="docstring"><header><a class="docstring-binding" id="PALEOboxes.SIMDutils.SIMDIter" href="#PALEOboxes.SIMDutils.SIMDIter"><code>PALEOboxes.SIMDutils.SIMDIter</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">SIMDIter(baseiter, Val{N})
SIMDIter(baseiter, ::Type{SIMD.Vec{N, U}})
SIMDIter(baseiter, ::Val{1}) # scalar fallback
SIMDIter(baseiter, ::Type{U}) where {U &lt;: Real} # scalar fallback</code></pre><p>Iterator that takes up to <code>N</code> SIMD elements at a time from <code>baseiter</code> (which should represent indices into a Vector). See Julia package <a href="https://github.com/eschnett/SIMD.jl">SIMD.jl</a></p><p>If <code>baseiter</code> contained 1 or more but less then <code>N</code> elements, then <code>indices</code> is filled with repeats of the last available element.</p><p>Returns Tuple of indices (length <code>N</code>).</p><p><strong>Examples</strong></p><pre><code class="nohighlight hljs">v_a = [1.0, 2.0, 3.0, 4.0, 5.0]
v_b = similar(v_a)

iter = eachindex(v_a) # iter should represent indices into a Vector

# simplest version - Float64 x 4, ie type of v_a x 4

for i in SIMDIter(iter, Val(4))
    x = v_a[i]  # x is a packed SIMD vector
    v_b[i] = x
end


# with type conversion - Float32 x 8, ie explicitly change Type of SIMD vector

ST = SIMD.Vec{8, Float32}}    
for i in SIMDIter(iter, ST)
    #   v = vec[i]  &lt;--&gt; vgatherind(ST, vec, i)
    #   vec[i] = v  &lt;--&gt; vscatterind!(v, vec, i)
    #   vec[i] += v &lt;--&gt; vaddind!(v, vec, i) 

    x = vgatherind(ST, v_a, i)  # x is a packed SIMD vector with type conversion to Float32
    vscatterind!(x, v_b, i)
end</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/PALEOtoolkit/PALEOboxes.jl/blob/3a6af11e6f23cc9c2cd1953fc504a48747749f98/src/utils/SIMDutils.jl#L27-L69">source</a></section></article><h3 id="Adding-ReactionMethods"><a class="docs-heading-anchor" href="#Adding-ReactionMethods">Adding ReactionMethods</a><a id="Adding-ReactionMethods-1"></a><a class="docs-heading-anchor-permalink" href="#Adding-ReactionMethods" title="Permalink"></a></h3><article class="docstring"><header><a class="docstring-binding" id="PALEOboxes.ReactionMethod" href="#PALEOboxes.ReactionMethod"><code>PALEOboxes.ReactionMethod</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">ReactionMethod(
    methodfn::Function,
    reaction::AbstractReaction,
    name::String,
    varlists::Tuple{Vararg{AbstractVarList}},
    p, 
    operatorID::Vector{Int64}, 
    domain::AbstractDomain; 
    preparefn = (m, vardata) -&gt; vardata
) -&gt; m::ReactionMethod</code></pre><p>Defines a callback function <code>methodfn</code> with Variables <code>varlists</code>, to be called from the Model framework either during setup or as part of the main loop.</p><p><strong>Fields</strong></p><ul><li><p><code>methodfn</code>: callback from Model framework</p></li><li><p><code>reaction</code>: the Reaction that created this ReactionMethod</p></li><li><p><code>name</code>: a descriptive name, eg generated from the name of methodfn</p></li><li><p><code>varlists</code>: Tuple of VarLists, each representing a list of <a href="#PALEOboxes.VariableReaction"><code>VariableReaction</code></a>s.     Corresponding Variable accessors <code>vardata</code> (views on Arrays) will be provided to the <code>methodfn</code> callback.     NB: not concretely typed to reduce compile time, as not performance-critical</p></li><li><p><code>p</code>: optional context field (of arbitrary type) to store data needed by methodfn.</p></li><li><p><code>operatorID</code></p></li><li><p><code>domain</code></p></li><li><p><code>preparefn</code>: preparefn(m::ReactionMethod, vardata::Tuple) -&gt; modified_vardata::Tuple      optionally modify <code>vardata</code> to eg add buffers. NB: not concretely typed as not performance-critical</p></li></ul><p><strong>methodfn</strong></p><p>The <code>methodfn</code> callback is:</p><pre><code class="nohighlight hljs">methodfn(m::ReactionMethod, pars, vardata::Tuple, cellrange::AbstractCellRange, modelctxt)</code></pre><p>or (if Parameters are not required):</p><pre><code class="nohighlight hljs">methodfn(m::ReactionMethod, vardata::Tuple, cellrange::AbstractCellRange, modelctxt)</code></pre><p>With arguments:</p><ul><li><code>m::ReactionMethod</code>: context is available as <code>m.reaction::AbstractReaction</code> (the Reaction that defined the <code>ReactionMethod</code>), and <code>m.p</code> (an arbitrary extra context field supplied when <code>ReactionMethod</code> created).</li><li><code>pars</code>: a struct with Parameters as fields (current just the ParametersTuple defined as <code>reaction.pars</code>)</li><li><code>vardata</code>: A Tuple of collections of views on Domain data arrays corresponding to <a href="#PALEOboxes.VariableReaction"><code>VariableReaction</code></a>s defined by <code>varlists</code></li><li><code>cellrange::AbstractCellRange</code>: range of cells to calculate.</li><li><code>modelctxt</code>:<ul><li>for a setup method, <code>:setup</code>, <code>:initial_value</code> or <code>:norm_value</code> defining the type of setup requested</li><li>for a main loop method <code>deltat</code> providing timestep information eg for rate throttling.</li></ul></li></ul><p><strong>preparefn</strong></p><p>An optional <code>preparefn</code> callback can be supplied eg to allocate buffers that require knowledge of the data types of <code>vardata</code> or to cache expensive calculations:</p><pre><code class="nohighlight hljs">preparefn(m::ReactionMethod, vardata::Tuple) -&gt; modified_vardata::Tuple</code></pre><p>This is called after model arrays are allocated, and prior to setup.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/PALEOtoolkit/PALEOboxes.jl/blob/3a6af11e6f23cc9c2cd1953fc504a48747749f98/src/ReactionMethod.jl#L1-L45">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="PALEOboxes.add_method_setup!" href="#PALEOboxes.add_method_setup!"><code>PALEOboxes.add_method_setup!</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">add_method_setup!(reaction::AbstractReaction, method::AbstractReactionMethod)
add_method_setup!(reaction::AbstractReaction, methodfn::Function, vars::Tuple{Vararg{AbstractVarList}}; kwargs...) -&gt; ReactionMethod</code></pre><p>Add or create-and-add a setup method (called before main loop) eg to set persistent data or initialize state variables. <code>methodfn</code>, <code>vars</code>, <code>kwargs</code> are passed to <a href="#PALEOboxes.ReactionMethod"><code>ReactionMethod</code></a>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/PALEOtoolkit/PALEOboxes.jl/blob/3a6af11e6f23cc9c2cd1953fc504a48747749f98/src/Reaction.jl#L292-L298">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="PALEOboxes.add_method_initialize!" href="#PALEOboxes.add_method_initialize!"><code>PALEOboxes.add_method_initialize!</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">add_method_initialize!(reaction::AbstractReaction, method::AbstractReactionMethod)
add_method_initialize!(reaction::AbstractReaction, methodfn::Function, vars::Tuple{Vararg{AbstractVarList}}; kwargs...) -&gt; ReactionMethod</code></pre><p>Add or create-and-add an initialize method (called at start of each main loop iteration)  eg to zero out accumulator Variables. <code>methodfn</code>, <code>vars</code>, <code>kwargs</code> are passed to <a href="#PALEOboxes.ReactionMethod"><code>ReactionMethod</code></a>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/PALEOtoolkit/PALEOboxes.jl/blob/3a6af11e6f23cc9c2cd1953fc504a48747749f98/src/Reaction.jl#L307-L314">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="PALEOboxes.add_method_do!" href="#PALEOboxes.add_method_do!"><code>PALEOboxes.add_method_do!</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">add_method_do!(reaction::AbstractReaction, method::AbstractReactionMethod)
add_method_do!(reaction::AbstractReaction, methodfn::Function, vars::Tuple{Vararg{AbstractVarList}}; kwargs...) -&gt; ReactionMethod</code></pre><p>Add or create and add a main loop method. <code>methodfn</code>, <code>vars</code>, <code>kwargs</code> are passed to <a href="#PALEOboxes.ReactionMethod"><code>ReactionMethod</code></a>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/PALEOtoolkit/PALEOboxes.jl/blob/3a6af11e6f23cc9c2cd1953fc504a48747749f98/src/Reaction.jl#L324-L330">source</a></section></article><h2 id="Predefined-ReactionMethods"><a class="docs-heading-anchor" href="#Predefined-ReactionMethods">Predefined ReactionMethods</a><a id="Predefined-ReactionMethods-1"></a><a class="docs-heading-anchor-permalink" href="#Predefined-ReactionMethods" title="Permalink"></a></h2><h3 id="Setup-and-initialization-of-Variables"><a class="docs-heading-anchor" href="#Setup-and-initialization-of-Variables">Setup and initialization of Variables</a><a id="Setup-and-initialization-of-Variables-1"></a><a class="docs-heading-anchor-permalink" href="#Setup-and-initialization-of-Variables" title="Permalink"></a></h3><article class="docstring"><header><a class="docstring-binding" id="PALEOboxes.add_method_setup_initialvalue_vars_default!" href="#PALEOboxes.add_method_setup_initialvalue_vars_default!"><code>PALEOboxes.add_method_setup_initialvalue_vars_default!</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">add_method_setup_initialvalue_vars_default!(react::AbstractReaction, variables [; kwargs...])</code></pre><p>Create and add a default method to initialize Variables matching <code>filterfn</code> (defaults to state Variables) at beginning of integration.</p><p><strong>Setup callbacks used</strong></p><ul><li>State Variables and similar (<code>:vfunction != VF_Undefined</code>) are initialized in a setup callback with  <code>attribute_name in (:initial_value, :norm_value)</code>, with values from those Variable attributes.</li><li>If <code>force_state_norm_value=false</code>, other Variables (with <code>:vfunction == VF_Undefined</code>) are initialized in a setup callback with  <code>attribute_name=:setup</code>, with values from the <code>:initial_value</code> Variable attribute. NB: <code>filterfn</code> must be set to include these Variables.</li><li>If <code>force_initial_norm_value=true</code>, all Variables (including those with <code>:vfunction == VF_Undefined</code>) are initialised as state Variables</li></ul><p><strong>Keywords</strong></p><ul><li><code>filterfn</code>: set to f(var)::Bool to override the default selection for state variables only (Variables with <code>:vfunction in (VF_StateExplicit, VF_State, VF_Total, VF_Constraint)</code>)</li><li><code>force_initial_norm_value=false</code>: <code>true</code> to always use <code>:initial_value</code>, <code>:norm_value</code>, even for variables with <code>:vfunction=VF_Undefined</code></li><li><code>transfer_attribute_vars=[]</code>: Set to a list of the same length as <code>variables</code> to initialise <code>variables</code> from attributes of <code>transfer_attribute_vars</code>.</li><li><code>setup_callback=(method, attribute_name, var, vardata) -&gt; nothing</code>: Set to a function that is called  after each Variable initialisation eg to store norm values.</li><li><code>convertvars=[]</code></li><li><code>convertfn = (convertvars_tuple, i) -&gt; 1.0</code></li><li><code>convertinfo = &quot;&quot;</code></li></ul><p><strong>Including volume etc conversion</strong></p><p>Set <code>convertvars</code> to a Vector of Variables (eg for cell volume) and supply <code>convertfn</code> and <code>convertinfo</code>  to initialize to <code>:initial_value*convertfn(convertvars_tuple, i)</code> where the argument of <code>convertfn</code> is the Tuple generated by <code>VarList_tuple(convertvars)</code>.</p><p>Example: To interpret <code>:initial_value</code> as a concentration-like quantity:</p><pre><code class="nohighlight hljs">convertvars = [volume], 
convertfn = ((volume, ), i) -&gt; volume[i], 
convertinfo = &quot; * volume&quot;</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/PALEOtoolkit/PALEOboxes.jl/blob/3a6af11e6f23cc9c2cd1953fc504a48747749f98/src/reactionmethods/SetupInitializeUtilityMethods.jl#L5-L41">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="PALEOboxes.add_method_initialize_zero_vars_default!" href="#PALEOboxes.add_method_initialize_zero_vars_default!"><code>PALEOboxes.add_method_initialize_zero_vars_default!</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">add_method_initialize_zero_vars_default!(react::AbstractReaction, variables=PB.get_variables(react))</code></pre><p>Create and add a default method to initialize Variables to zero at beginning of each timestep. Defaults to adding all Variables from <code>react</code> with <code>:initialize_to_zero</code> attribute <code>true</code>.</p><p>NB: TODO variables are converted to VarDep (no dependency checking or sorting needed, could define a VarInit or similar?)</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/PALEOtoolkit/PALEOboxes.jl/blob/3a6af11e6f23cc9c2cd1953fc504a48747749f98/src/reactionmethods/SetupInitializeUtilityMethods.jl#L138-L145">source</a></section></article><h3 id="Adding-totals-for-Variables"><a class="docs-heading-anchor" href="#Adding-totals-for-Variables">Adding totals for Variables</a><a id="Adding-totals-for-Variables-1"></a><a class="docs-heading-anchor-permalink" href="#Adding-totals-for-Variables" title="Permalink"></a></h3><article class="docstring"><header><a class="docstring-binding" id="PALEOboxes.add_method_do_totals_default!" href="#PALEOboxes.add_method_do_totals_default!"><code>PALEOboxes.add_method_do_totals_default!</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">add_method_do_totals_default!(react::AbstractReaction; total_candidates=PB.get_variables(react)
    [filterfn] [, methodname] [, total_localnames] [, operatorID])</code></pre><p>Create and add a method to add total variables (Scalar Properties), for Variables in <code>total_candidates</code> that match <code>filterfn</code> (defaults to those that are Array Variables and have attribute `<code>:calc_total == true</code>).</p><p>NB: total Variables will require initialization to zero using <a href="#PALEOboxes.add_method_initialize_zero_vars_default!"><code>add_method_initialize_zero_vars_default!</code></a></p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/PALEOtoolkit/PALEOboxes.jl/blob/3a6af11e6f23cc9c2cd1953fc504a48747749f98/src/reactionmethods/VariableStatsMethods.jl#L1-L9">source</a></section></article><h3 id="Chemical-reactions"><a class="docs-heading-anchor" href="#Chemical-reactions">Chemical reactions</a><a id="Chemical-reactions-1"></a><a class="docs-heading-anchor-permalink" href="#Chemical-reactions" title="Permalink"></a></h3><article class="docstring"><header><a class="docstring-binding" id="PALEOboxes.RateStoich" href="#PALEOboxes.RateStoich"><code>PALEOboxes.RateStoich</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">RateStoich(ratevartemplate, stoich_statevarname; deltavarname_eta=nothing,
           sms_prefix=&quot;&quot;, sms_suffix=&quot;_sms&quot;) -&gt; RateStoich</code></pre><p>Calculate fluxes for a biogeochemical reaction given rate, stoichiometry, and optionally isotope eta.</p><p>Add to a Reaction using <a href="#PALEOboxes.create_ratestoich_method"><code>create_ratestoich_method</code></a> and <a href="#PALEOboxes.add_method_do!"><code>add_method_do!</code></a>.  </p><p>A Property Variable should be set to provide the reaction rate (often this is implemented by another method of the same Reaction).</p><p>This method will then link to that (using the local and link names supplied by <code>ratevartemplate</code>) and calculate the appropriate product rates, omitting products that are not present (<code>VariableReaction</code> not linked) in the <code>Model</code> configuration.</p><p><strong>Arguments:</strong></p><ul><li><code>ratevartemplate::Union{VarPropT, VarDepT}</code>: used to define the rate variable local and link names.</li><li><code>stoich_statevarname</code>: collection of Tuple(stoichiometry, name) eg ((-2.0, &quot;O2&quot;), (-1.0,&quot;H2S::Isotope&quot;), (1.0, &quot;SO4::Isotope&quot;))</li><li><code>deltavarname_eta</code>: optional tuple of variable delta + eta (&quot;SO4_delta&quot;, -30.0) or (&quot;SO4_delta&quot;, rj.pars.delta). If a Parameter is supplied, this is read in <code>do_react_ratestoich</code> to allow modification.</li></ul><p><strong>Examples:</strong></p><p>Create a <code>RateStoich</code> representing the reaction   2 O2 + H2S -&gt; H2SO4</p><pre><code class="language-julia-repl hljs">julia&gt; myratevar = PALEOboxes.VarProp(&quot;myrate&quot;, &quot;mol yr-1&quot;, &quot;a rate&quot;);

julia&gt; rs = PALEOboxes.RateStoich(myratevar, ((-2.0, &quot;O2&quot;), (-1.0,&quot;H2S&quot;), (1.0, &quot;SO4&quot;)));

julia&gt; rs.stoich_statevarname
((-2.0, &quot;O2&quot;), (-1.0, &quot;H2S&quot;), (1.0, &quot;SO4&quot;))</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/PALEOtoolkit/PALEOboxes.jl/blob/3a6af11e6f23cc9c2cd1953fc504a48747749f98/src/reactionmethods/RateStoich.jl#L2-L31">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="PALEOboxes.create_ratestoich_method" href="#PALEOboxes.create_ratestoich_method"><code>PALEOboxes.create_ratestoich_method</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">create_ratestoich_method(reaction::AbstractReaction, ratestoich::RateStoich; isotope_data=ScalarData)
    -&gt; ReactionMethod</code></pre><p>Create method (see <a href="#PALEOboxes.RateStoich"><code>RateStoich</code></a>).</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/PALEOtoolkit/PALEOboxes.jl/blob/3a6af11e6f23cc9c2cd1953fc504a48747749f98/src/reactionmethods/RateStoich.jl#L98-L103">source</a></section></article><h2 id="Internal-details-of-Variable-arrays-accessor-generation"><a class="docs-heading-anchor" href="#Internal-details-of-Variable-arrays-accessor-generation">Internal details of Variable arrays accessor generation</a><a id="Internal-details-of-Variable-arrays-accessor-generation-1"></a><a class="docs-heading-anchor-permalink" href="#Internal-details-of-Variable-arrays-accessor-generation" title="Permalink"></a></h2><p><a href="#PALEOboxes.VariableReaction"><code>VariableReaction</code></a>s in the <a href="#PALEOboxes.AbstractVarList"><code>AbstractVarList</code></a>s for a <a href="#PALEOboxes.ReactionMethod"><code>ReactionMethod</code></a> are processed by <a href="#PALEOboxes.create_accessor"><code>create_accessor</code></a> to supply <code>view</code>s on arrays as corresponding arguments to the <a href="#PALEOboxes.ReactionMethod"><code>ReactionMethod</code></a> function.</p><article class="docstring"><header><a class="docstring-binding" id="PALEOboxes.create_accessor" href="#PALEOboxes.create_accessor"><code>PALEOboxes.create_accessor</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs"> create_accessor(var::VariableReaction, modeldata, arrays_idx, components, [,forceview=false])
    -&gt; accessor or (accessor, subdomain_indices)</code></pre><p>Creates a <code>view</code> on a (single) <a href="../DomainsVariablesFields/#PALEOboxes.VariableDomain"><code>VariableDomain</code></a> data array linked by <code>var::</code><a href="#PALEOboxes.VariableReaction"><code>VariableReaction</code></a>. Called by an <a href="#PALEOboxes.AbstractVarList"><code>AbstractVarList</code></a> <a href="#PALEOboxes.create_accessors"><code>create_accessors</code></a> implementation to generate a collection of <code>views</code> for multiple <a href="#PALEOboxes.VariableReaction"><code>VariableReaction</code></a>s.</p><p>Returns:</p><ul><li>if <code>var</code> is linked, an <code>accessor</code> or Tuple <code>(accessor, subdomain_indices)</code> that provides a <code>view</code> on variable data.</li><li>if <code>var</code> is not linked, <code>nothing</code> if <code>var</code> is optional, or errors and doesn&#39;t return if <code>var</code> is non-optional.</li></ul><p>Mapping of indices for Subdomains &lt;–&gt; Domains:</p><ul><li>if no Subdomain, returns unmodified indices (if <code>forceview=false</code>),    or an equivalent view (if <code>forceview=true</code>, this is to help type stability) </li><li>if Variable is a Domain interior and Subdomain is a Domain boundary,   <code>accessor</code> is a view with a subset of Domain indices.</li><li>if Variable is a Domain boundary and Subdomain is the Domain interior,   returns a Tuple with <code>subdomain_indices</code>,  length(Subdomain size), with <code>missing</code> for interior points.</li></ul><p>Mapping of multi-component (Isotope) Variables:</p><ul><li>If <code>components=false</code>:<ul><li>map multi-component Variable to <code>accessor::IsotopeArray</code></li><li>return a single-component Variable as a <code>accessor::AbstractArray</code>. </li></ul></li><li>If <code>components=true</code>:<ul><li>variable data as a <code>accessor::Vector{Array}</code>, length=number of components</li></ul></li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/PALEOtoolkit/PALEOboxes.jl/blob/3a6af11e6f23cc9c2cd1953fc504a48747749f98/src/VariableReaction.jl#L672-L698">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="PALEOboxes.create_accessors" href="#PALEOboxes.create_accessors"><code>PALEOboxes.create_accessors</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">create_accessors(varlist::AbstractVarList, modeldata::AbstractModelData, arrays_idx::Int) -&gt; vardata</code></pre><p>Return a collection <code>vardata</code> of views on Domain data arrays for VariableReactions in <code>varlist</code>. Collection and view are determined by <code>varlist</code> Type.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/PALEOtoolkit/PALEOboxes.jl/blob/3a6af11e6f23cc9c2cd1953fc504a48747749f98/src/VariableReaction.jl#L435-L440">source</a></section></article></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../Solver API/">« Solver API</a><a class="docs-footer-nextpage" href="../ReactionCatalog/">Generic Reaction catalog »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.25 on <span class="colophon-date" title="Monday 7 August 2023 11:05">Monday 7 August 2023</span>. Using Julia version 1.6.7.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
